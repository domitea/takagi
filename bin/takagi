#!/usr/bin/env ruby
# frozen_string_literal: true

# Takagi CLI - Minimal commands for server management and information
# Project generation and advanced features available in takagi-devtools gem

require_relative '../lib/takagi'
require_relative '../lib/takagi/branding'

command = ARGV[0]
args = ARGV[1..]

case command
when 'server', 's'
  # Parse options
  port = 5683
  protocols = [:udp]
  banner = true
  app_file = 'app.rb'

  i = 0
  while i < args.length
    case args[i]
    when '-p', '--port'
      port = args[i + 1].to_i
      i += 1
    when '--tcp'
      protocols << :tcp unless protocols.include?(:tcp)
    when '--udp'
      protocols << :udp unless protocols.include?(:udp)
    when '--no-banner'
      banner = false
    when '-f', '--file'
      app_file = args[i + 1]
      i += 1
    end
    i += 1
  end

  # Load the application
  unless File.exist?(app_file)
    puts Takagi::Branding.error("Application file not found: #{app_file}")
    puts Takagi::Branding.info("Create #{app_file} or specify with -f FILE")
    exit 1
  end

  puts Takagi::Branding.log("Loading application from #{app_file}...")
  require File.expand_path(app_file)

  # Find the application class (first class inheriting from Takagi::Base)
  app_class = ObjectSpace.each_object(Class).find { |klass| klass < Takagi::Base && klass != Takagi::Base }

  unless app_class
    puts Takagi::Branding.error("No Takagi::Base subclass found in #{app_file}")
    puts Takagi::Branding.info("Define a class that inherits from Takagi::Base")
    exit 1
  end

  # Start the server
  app_class.run!(port: port, protocols: protocols, banner: banner)

when 'routes', 'r'
  # Load the application
  app_file = 'app.rb'
  args.each_with_index do |arg, i|
    app_file = args[i + 1] if arg == '-f' || arg == '--file'
  end

  unless File.exist?(app_file)
    puts Takagi::Branding.error("Application file not found: #{app_file}")
    exit 1
  end

  require File.expand_path(app_file)

  # Find the application class
  app_class = ObjectSpace.each_object(Class).find { |klass| klass < Takagi::Base && klass != Takagi::Base }

  unless app_class
    puts Takagi::Branding.error("No Takagi::Base subclass found")
    exit 1
  end

  puts Takagi::Branding.section('Registered Routes')
  puts

  router = app_class.router
  routes = router.instance_variable_get(:@routes)

  if routes.empty?
    puts Takagi::Branding.info('No routes registered')
  else
    # Group routes by method
    grouped = routes.values.group_by(&:method).sort_by { |method, _| method }

    grouped.each do |method, entries|
      entries.each do |entry|
        metadata_str = if entry.metadata.any?
                         tags = entry.metadata.map { |k, v| "#{k}:#{v}" }.join(', ')
                         " [#{tags}]"
                       else
                         ''
                       end

        puts Takagi::Branding.log("#{method.ljust(8)} #{entry.path}#{metadata_str}")
      end
    end

    puts
    puts Takagi::Branding.success("#{routes.size} routes registered")
  end

when 'version', 'v', '-v', '--version'
  version = defined?(Takagi::VERSION) ? Takagi::VERSION : '1.0.0'
  puts Takagi::Branding::LOGO_WITH_NAME + " v#{version}"

when 'help', 'h', '-h', '--help', nil
  puts <<~HELP

    #{Takagi::Branding::BANNER}

    Usage: takagi COMMAND [options]

    Commands:
      server, s          Start the Takagi server
      routes, r          List all registered routes
      version, v         Show Takagi version
      help, h            Show this help message

    Server Options:
      -p, --port PORT    Port to bind to (default: 5683)
      --tcp              Enable TCP protocol
      --udp              Enable UDP protocol (default)
      --no-banner        Disable startup banner
      -f, --file FILE    Application file (default: app.rb)

    Routes Options:
      -f, --file FILE    Application file (default: app.rb)

    Examples:
      takagi server                    # Start server on port 5683 (UDP)
      takagi server -p 5684            # Start on custom port
      takagi server --tcp --udp        # Enable both protocols
      takagi server --no-banner        # No banner
      takagi routes                    # List all routes
      takagi version                   # Show version

    For project generation and advanced features, install:
      gem install takagi-devtools

    #{Takagi::Branding::WAVE_LINE}

  HELP

else
  puts Takagi::Branding.error("Unknown command: #{command}")
  puts Takagi::Branding.info("Run 'takagi help' for usage information")
  exit 1
end
